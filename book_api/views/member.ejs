<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('./head'); %>
</head>
<body class="container">

<header>
    <%- include('./header', { isAuthorized: true }); %>
</header>

<main>
  <% if (locals.members) { %>
    <div class="t-profile-information">
      <div class="t-left-panel-avatar-and-name">
          <div class="t-avatar"><img src="/images/avatar.jpg"></div>
          <div class="t-full-name"><%=members[0].firstname + ' ' + members[0].lastname%></div>
          <button id="edit-my-profile">Edit my profile</button>
      </div>
      <table class="t-right-panel-other-info">
           <tr>
               <td><label>Full name </label></td>
               <td><label class="non-editable" name="profile-info-to-edit" contentEditable="false"><%=members[0].firstname + ' ' + members[0].lastname%></label></td>
           </tr>
           
           <tr>
               <td><label>Email </label></td>
               <td><label class="non-editable" name="profile-info-to-edit" contentEditable="false"><%=members[0].emailaddress%></label></td>
           </tr>
           <tr> 
               <td><label>Phone </label></td>
               <td><label class="non-editable" name="profile-info-to-edit" contentEditable="false"><%=members[0].phonenumber%></label></td>
           </tr>
           <tr>
               <td><label>Address </label></td>
               <td><label class="non-editable" name="profile-info-to-edit" contentEditable="false"><%=members[0].address%></label></td>
           </tr>
           <tr>
          <td><label>Credit score</label></td>
          <td><label>
              <style type="text/css">
                  .fa-star.checked, .fa-star-half.checked { color: orange; }
              </style>
              <% for (let i=0; i<Math.floor(members[0].creditScore); i++) { %>
                <span class="fa fa-star checked"></span>
              <% } %>
              <% const scoreDecimalPart = members[0].creditScore - Math.floor(members[0].creditScore); %>
              <% if ( scoreDecimalPart > 0.75 ) { %> <!-- full star -->
                <span class="fa fa-star checked"></span>
              <% } else if (0.25 < scoreDecimalPart) { %> <!-- half star -->
                <span class="fa fa-star-half checked"></span>
              <% } %>
          </label></td>
          </tr>
      </table>
    </div>
    <script type="text/javascript">
      //profile pages
      function toggleEdit() {
          let editMyProfileButton = document.getElementById('edit-my-profile');

          if (editMyProfileButton.innerText == 'Edit my profile'){  //contentEditable == false
              editMyProfileButton.innerText = 'Done editing';
          } else {
              editMyProfileButton.innerText = 'Edit my profile';
          }
          
          for (let element of document.getElementsByName('profile-info-to-edit')){
              element.onkeypress = (event) => {
                  if (event.key == 'Enter') {
                      event.preventDefault();
                  }
              }

                  if (element.isContentEditable == false){
                    element.contentEditable = true;
                    element.classList.remove('non-editable');
                    element.classList.add('editable');
                  } else {
                    element.contentEditable = false;
                    element.classList.remove('editable');
                    element.classList.add('non-editable');
                  }
          }
      }

      const element = document.getElementById('edit-my-profile');
      if (element) element.onclick=toggleEdit;

      var current_page = 1;
      var records_per_page = 4;

      var objJson = [
          { Book: "Book 1"},
          { Book: "Book 2"},
          { Book: "Book 3"},
          { Book: "Book 4"},
          { Book: "Book 5"},
          { Book: "Book 6"},
          { Book: "Book 7"},
          { Book: "Book 8"},
          { Book: "Book 9"},
          { Book: "Book 10"}
      ]; // Can be obtained from another source, such as your objJson variable

      function prevPage()
      {
          if (current_page > 1) {
              current_page--;
              changePage(current_page);
          }
      }

      function nextPage()
      {
          if (current_page < numPages()) {
              current_page++;
              changePage(current_page);
          }
      }
          
      function changePage(page)
      {
          var btn_next = document.getElementById("btn_next");
          var btn_prev = document.getElementById("btn_prev");
          var listing_table = document.getElementsByClassName("t-book-listing")[0];
          var page_span = document.getElementById("page_span");

          btn_next.onclick = nextPage;
          btn_prev.onclick = prevPage;
       
          // Validate page
          if (page < 1) page = 1;
          if (page > numPages()) page = numPages();

          listing_table.innerHTML = "";

          for (var i = (page-1) * records_per_page; i < (page * records_per_page); i++) {
              if (i >= objJson.length) break;  //last page may not have enough items like previous pages
              listing_table.innerHTML += objJson[i].Book + "<br>";
          }
          page_span.innerHTML = 'Current page: ' + page;

          if (page == 1) {
              btn_prev.style.visibility = "hidden";
          } else {
              btn_prev.style.visibility = "visible";
          }

          if (page == numPages()) {
              btn_next.style.visibility = "hidden";
          } else {
              btn_next.style.visibility = "visible";
          }
      }

      function numPages()
      {
          return Math.ceil(objJson.length / records_per_page);
      }
    // end of profile page
    </script>

    <h2>My books</h2>
        <ul>
          <% for (let book of books) { %>
            <li><a href='/book?idbook=<%=book.idbook%>'><%=book.title%></a></li>
          <% } %>
        </ul>
    <form action="/book/upload" method="POST">
      <script type="text/javascript">
        insertHiddenIdmemberTo(document.currentScript.parentNode);
      </script>
      <input type="submit" name="" value="Upload a book">
    </form>

    <h2>Search for a book</h2>
  <% } %>

  <button class="exchange-history">View My Exchange History</button>
</main>

<footer>
    <%- include('./footer'); %>
</footer>


</body>
</html>